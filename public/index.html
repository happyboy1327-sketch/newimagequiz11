<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ëœë¤ ìœ„ì¸ í€´ì¦ˆ</title>
<style>
  body{font-family:'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; background:#f0f2f5; margin:0;}
  .card{width:90%; max-width:420px; background:#fff; border-radius:16px; padding:24px; text-align:center; box-shadow:0 8px 24px rgba(0,0,0,0.1);}
  
  /* ì´ë¯¸ì§€ ì˜ì—­ */
  .img-box {width:100%; height:320px; margin-bottom:16px; border-radius:12px; background:#f8f9fa; overflow:hidden; position:relative;}
  img {width:100%; height:100%; object-fit:contain; display:block;}
  
  #hint {margin:12px 0; font-size:0.95rem; color:#495057; background:#e9ecef; padding:12px; border-radius:8px; line-height:1.5; word-break:keep-all;}
  
  input {width:100%; padding:14px; margin-bottom:12px; border-radius:8px; border:1px solid #ced4da; font-size:1rem; box-sizing:border-box; outline:none;}
  input:focus {border-color:#4c6ef5; box-shadow:0 0 0 3px rgba(76,110,245,0.2);}
  
  .btn-group {display:flex; gap:8px;}
  button {flex:1; padding:14px; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:1rem; color:#fff;}
  #checkBtn {background:#a4fa23;}
  #checkBtn:hover {background:#2b4bdb;}
  #reloadBtn {background:#38ebf4;}
  #reloadBtn:hover {background:#368df1;}
  button:disabled {background:#dee2e6; cursor:not-allowed;}
  
  #timer {font-weight:800; color:#fa5252; margin-bottom:8px; font-size:1.4rem;}
  
  #result {margin-top:20px; text-align:left;}
  .res-header {font-size:1.2rem; font-weight:800; margin-bottom:8px; text-align:center;}
  .desc-box {font-size:0.9rem; color:#343a40; background:#f1f3f5; padding:12px; border-radius:8px; line-height:1.6;}
</style>
</head>
<body>

<div class="card">
  <h2>ëœë¤ ìœ„ì¸ í€´ì¦ˆ</h2>
  <div id="timer">15s</div>
  
  <div class="img-box">
    <img id="person-img" src="" alt="ìœ„ì¸ ì´ë¯¸ì§€" referrerpolicy="no-referrer">
  </div>
  
  <div id="hint">ë°ì´í„° ê²€ì¦ ë° ìˆ˜ì‹  ì¤‘...</div>

  
  <input id="answer" placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off">
  
  <div class="btn-group">
    <button id="checkBtn">ì •ë‹µ í™•ì¸</button>
    <button id="reloadBtn">ë‹¤ìŒ ë¬¸ì œ</button>
  </div>
  
  <div id="result"></div>
</div>

<script>
let retryCount = 0;
const MAX_RETRY = 3;

let sessionId = localStorage.getItem('sessionId') || `session_${Date.now()}`;
localStorage.setItem('sessionId', sessionId);

let currentData = null, timer = null, timeLeft = 15;

// íˆ¬ëª… ì´ë¯¸ì§€ (ë¡œë”©ìš©)
const LOADING_IMG = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

async function loadQuiz(){
  clearInterval(timer);
  document.getElementById('result').innerHTML = "";
  document.getElementById('answer').value = "";
  document.getElementById('answer').focus();
  document.getElementById('checkBtn').disabled = true;
  
  const img = document.getElementById('person-img');
  img.src = LOADING_IMG;

  // ì´ë¯¸ì§€ íŒ¨ìŠ¤ ì²˜ë¦¬
  img.onerror = () => {
    console.warn("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ â†’ íŒ¨ìŠ¤");

    retryCount++;
    if (retryCount > MAX_RETRY) {
        document.getElementById('hint').textContent = "ì´ë¯¸ì§€ ë¶ˆì•ˆì •ìœ¼ë¡œ ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        return;
    }

    // ìë™ ì¬ìš”ì²­
    loadQuiz();
};

  
  document.getElementById('hint').textContent = "ìµœì ì˜ ì´ë¯¸ì§€ë¥¼ ì„ ë³„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
  timeLeft = 15;
  document.getElementById('timer').textContent = `${timeLeft}s`;

  try{
    const res = await fetch(`/api/quiz?sessionId=${sessionId}`);
    if(res.status === 503) {
        document.getElementById('hint').textContent = "ì„œë²„ê°€ ì¢‹ì€ ì´ë¯¸ì§€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ 'ë‹¤ìŒ ë¬¸ì œ'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        document.getElementById('reloadBtn').disabled = false;
        return;
    }
    
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    currentData = data;
    img.src = data.image;
    img.onload = () => {
    retryCount = 0; // ì •ìƒ ì´ë¯¸ì§€ â†’ ì¹´ìš´í„° ì´ˆê¸°í™”
};

    document.getElementById('hint').textContent = data.hint;
    
    document.getElementById('checkBtn').disabled = false;
    startTimer();

  }catch(e){
    console.error(e);
    document.getElementById('hint').textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  }
}

function startTimer(){
  timer = setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').textContent = `${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(timer);
      showResult(false, true);
    }
  }, 1000);
}

function showResult(isCorrect, isTimeout=false){
  clearInterval(timer);
  document.getElementById('checkBtn').disabled = true;
  
  const color = isCorrect ? "#40c057" : "#fa5252";
  const title = isTimeout ? "â° ì‹œê°„ ì´ˆê³¼" : (isCorrect ? "ğŸ‰ ì •ë‹µ!" : "âŒ ë•¡!");
  
  document.getElementById('result').innerHTML = `
    <div class="res-header" style="color:${color}">${title}</div>
    <div class="res-header">${currentData.name}</div>
    <div class="desc-box">${currentData.description}</div>
  `;
}

document.getElementById('checkBtn').addEventListener('click', ()=>{
  if(!currentData) return;
  const user = document.getElementById('answer').value.replace(/\s+/g,'').trim();
  const correct = currentData.name.replace(/\s+/g,'').trim();
  if(!user) return alert("ë‹µì„ ì…ë ¥í•˜ì„¸ìš”");
  showResult(user === correct);
});

document.getElementById('reloadBtn').addEventListener('click', loadQuiz);
document.getElementById('answer').addEventListener('keydown', e=>{ if(e.key==="Enter") document.getElementById('checkBtn').click(); });

window.addEventListener('load', loadQuiz);
</script>
</body>
</html>
